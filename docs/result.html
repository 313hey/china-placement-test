<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>中文分级测评 | 成绩结果</title>
  <style>
    :root{
      --bg:#f7f7f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(17,24,39,.10);
      --shadow:0 18px 50px rgba(0,0,0,.08);
      --radius:22px;

      --red:#e11d48;
      --red2:#ff2d55;
      --focus:rgba(225,29,72,.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      background:
        radial-gradient(1100px 420px at 20% -10%, rgba(255,45,85,.18), transparent 65%),
        radial-gradient(900px 360px at 90% 0%, rgba(225,29,72,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 40px;}
    .top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .title{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg,var(--red2),var(--red));
      box-shadow:0 14px 32px rgba(225,29,72,.25);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
      user-select:none;
    }
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:14px;line-height:1.6}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .scoreBig{
      display:flex;gap:10px;align-items:baseline;flex-wrap:wrap;
      font-weight:950;
      font-size:26px;
    }
    .scoreBig small{
      font-size:14px;font-weight:800;color:rgba(17,24,39,.65);
    }
    .metaRow{
      margin-top:10px;
      display:flex;gap:16px;flex-wrap:wrap;
      color:rgba(17,24,39,.68);
      font-size:13.5px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);background:rgba(255,255,255,.85);
      font-size:13px;color:var(--muted);
    }
    .btn{
      padding:11px 14px;border-radius:16px;border:1px solid rgba(17,24,39,.14);
      background:#fff;cursor:pointer;font-size:14px;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:linear-gradient(135deg,var(--red2),var(--red));
      border-color:transparent;color:#fff;font-weight:900;
      box-shadow:0 14px 26px rgba(225,29,72,.22);
    }
    .btnGhost:hover{border-color:rgba(225,29,72,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}

    .grid2{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;
    }
    @media (max-width:760px){ .grid2{grid-template-columns:1fr;} }

    .miniCard{
      border:1px solid rgba(17,24,39,.10);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }
    .miniTitle{font-weight:950;margin:0 0 6px;font-size:14px;color:rgba(17,24,39,.78)}
    .miniScore{font-weight:950;font-size:20px}
    .bar{height:10px;border-radius:999px;background:rgba(17,24,39,.08);overflow:hidden;margin-top:10px}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--red2),var(--red))}
    .empty{
      padding:16px;border-radius:18px;border:1px dashed rgba(17,24,39,.22);
      color:rgba(17,24,39,.65);background:rgba(255,255,255,.75);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo">绩</div>
        <div>
          <h1>成绩结果</h1>
          <div class="muted">已生成结果（提交到表单失败也不影响显示）</div>
        </div>
      </div>
      <div class="pill" id="whoPill">—</div>
    </div>

    <div class="card" id="mainCard">
      <div class="scoreBig">
        <span id="totalScore">—</span>
        <small id="totalPossible">/ —</small>
      </div>
      <div class="metaRow" id="metaRow"></div>

      <div class="grid2" id="sectionGrid"></div>

      <div class="row">
        <button class="btn btnGhost" id="backExamBtn">返回试卷</button>
        <button class="btn btnPrimary" id="backHomeBtn">回到首页</button>
      </div>
    </div>

    <div class="card" id="emptyCard" style="display:none">
      <div class="empty">
        没有找到本次成绩数据。<br/>
        可能原因：你还没有提交，或清除了浏览器记录。<br/>
        <div style="margin-top:12px">
          <button class="btn btnPrimary" id="goHomeBtn2">回到首页</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LS = {
      name: "quiz_name",
      school: "quiz_school",
      result: "quiz_result"
    };

    function $(id){ return document.getElementById(id); }
    function safeParse(json){
      try{ return JSON.parse(json); }catch(e){ return null; }
    }

    function fmtTime(ts){
      try{
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "";
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }catch(e){ return ""; }
    }

    function pct(score, possible){
      if (!possible || possible <= 0) return 0;
      return Math.max(0, Math.min(100, Math.round((score/possible)*100)));
    }

    function sectionName(key){
      if (key === "listening") return "听力 / Listening";
      if (key === "reading") return "选择题 / MCQ";
      return key;
    }

    const name = localStorage.getItem(LS.name) || "";
    const school = localStorage.getItem(LS.school) || "";
    $("whoPill").textContent = `${name || "（未填姓名）"} ｜ ${school || "（未填项目）"}`;

    const payload = safeParse(localStorage.getItem(LS.result));
    if (!payload){
      $("mainCard").style.display = "none";
      $("emptyCard").style.display = "block";
      $("goHomeBtn2").onclick = () => location.href = "./index.html";
    } else {
      const total = Number(payload.totalScore ?? 0);
      const possible = Number(payload.totalPossible ?? 25);

      $("totalScore").textContent = `总分：${total}`;
      $("totalPossible").textContent = `/ ${possible}`;

      const meta = [];
      meta.push(`姓名：${name || "—"}`);
      meta.push(`项目：${school || "—"}`);
      const t = fmtTime(payload.ts);
      if (t) meta.push(`时间：${t}`);
      $("metaRow").textContent = meta.join(" ｜ ");

      const bd = payload.breakdown || {};
      const grid = $("sectionGrid");
      grid.innerHTML = "";

      // Listening + MCQ cards
      ["listening","reading"].forEach(k => {
        const info = bd[k] || { score: 0, possible: 0 };
        const s = Number(info.score ?? 0);
        const p = Number(info.possible ?? 0);

        const card = document.createElement("div");
        card.className = "miniCard";

        const percent = pct(s, p);

        card.innerHTML = `
          <div class="miniTitle">${sectionName(k)}</div>
          <div class="miniScore">${s} / ${p}</div>
          <div class="bar"><div style="width:${percent}%"></div></div>
          <div class="muted" style="margin-top:8px">${percent}%</div>
        `;
        grid.appendChild(card);
      });

      $("backExamBtn").onclick = () => location.href = "./exam.html";
      $("backHomeBtn").onclick = () => location.href = "./index.html";
    }
  </script>
</body>
</html>